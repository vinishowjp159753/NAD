<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard ESPEP — Compras (Tudo em 1 arquivo)</title>

<!-- Favicon SVG (livro simplificado) embutido -->
<link rel="icon" href="data:image/svg+xml;utf8,
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
  <rect x='12' y='18' width='76' height='64' rx='8' fill='%23003366'/>
  <path d='M24 28 C44 36, 56 36, 76 28' stroke='%23ffffff' stroke-width='3' fill='none' stroke-linecap='round'/>
</svg>">

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- SheetJS (XLSX) CDN for real .xlsx export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Bootstrap 5 CSS & JS (for modal) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
  :root{
    --espep-blue: #003366;
    --espep-blue-2: #00509e;
    --accent: #f1c40f;
    --bg: #f6f8fb;
    --card: #fff;
    --muted: #6c757d;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#071122; --card:#0f1724; --muted:#9aa6b2; }
  }
  html,body{ height:100%; margin:0; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background:var(--bg); color:#1f2937; -webkit-font-smoothing:antialiased;}
  header{ background: linear-gradient(90deg,var(--espep-blue),var(--espep-blue-2)); color:white; padding:12px 16px; display:flex; align-items:center; gap:12px; box-shadow:0 4px 18px rgba(0,0,0,0.08);}
  .brand { display:flex; align-items:center; gap:8px; font-weight:700; }
  .brand svg{ border-radius:6px; }
  .top-actions { margin-left:auto; display:flex; gap:8px; align-items:center; }

  .main-wrap { padding:16px; display:grid; grid-template-columns: 240px 1fr; gap:16px; align-items:start; }
  @media (max-width: 992px){ .main-wrap { grid-template-columns: 1fr; } }

  .sidebar { background:linear-gradient(180deg,var(--espep-blue),var(--espep-blue-2)); color:white; border-radius:10px; padding:12px; min-height:280px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
  .sidebar a{ color:rgba(255,255,255,0.95); display:block; padding:10px; border-radius:8px; text-decoration:none; margin-bottom:6px; font-weight:600;}
  .sidebar a.active, .sidebar a:hover { background: rgba(255,255,255,0.06); transform: translateX(6px); }

  .content { display:flex; flex-direction:column; gap:12px; }

  .grid { display:grid; gap:12px; grid-template-columns: repeat(3, 1fr); }
  @media (max-width: 1200px){ .grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 768px){ .grid { grid-template-columns: 1fr; } }

  .card { background:var(--card); border-radius:10px; padding:12px; box-shadow:0 6px 18px rgba(16,24,40,0.06); }
  .card-header { font-weight:700; color:var(--espep-blue); margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; gap:8px; }

  .metrics { display:flex; gap:8px; }
  .metric { flex:1; padding:10px; border-radius:8px; background:linear-gradient(90deg,#fff,#f5f7fb); text-align:center; }
  .metric .value { font-size:1.25rem; font-weight:800; color:var(--espep-blue); }
  .metric .label { font-size:0.85rem; color:var(--muted); }

  .filters { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .filters select, .filters input[type="range"], .filters input[type="number"], .filters input[type="text"]{ padding:8px; border-radius:8px; border:1px solid #e2e8f0; min-width:160px; }

  .chart-box { height:280px; position:relative; }
  .chart-box canvas { width:100% !important; height:100% !important; }

  .table-wrap { max-height:420px; overflow:auto; }
  table{ width:100%; border-collapse:collapse; }
  thead th { position:sticky; top:0; background:var(--espep-blue); color:white; z-index:2; }
  td, th { padding:8px; border-bottom:1px solid #e6eef8; text-align:left; font-size:0.92rem; }
  tr.highlight { background: rgba(0,80,150,0.05); }

  .small-muted { font-size:0.85rem; color:var(--muted); }

  .mobile-row { display:none; }
  @media (max-width: 576px){ .desktop-row { display:none; } .mobile-row { display:flex; gap:8px; } .filters select { min-width:120px; } }

  .mapping-grid { display:flex; gap:8px; flex-direction:column; }
  .mapping-row { display:flex; gap:8px; align-items:center; }
  .mapping-row select { flex:1; padding:8px; border-radius:6px; }

  .btn-espep { background:var(--espep-blue); color:white; border-radius:8px; padding:8px 12px; border:none; }
  .btn-outline-espep { background:transparent; color:var(--espep-blue); border:1px solid var(--espep-blue); border-radius:8px; padding:8px 12px; }
</style>
</head>
<body>

<header>
  <div class="brand">
    <svg width="36" height="36" viewBox="0 0 100 100" aria-hidden="true">
      <rect x="12" y="18" width="76" height="64" rx="8" fill="#003366"/>
      <path d="M24 28 C44 36, 56 36, 76 28" stroke="#fff" stroke-width="3" fill="none" stroke-linecap="round"/>
    </svg>
    <div>ESPEP • Dashboard de Compras</div>
  </div>

  <div class="top-actions">
    <button id="btn-import-top" class="btn-outline-espep btn-sm">Importar .CSV</button>
    <button id="btn-export-top" class="btn-espep btn-sm">Exportar Excel (.xlsx)</button>
    <div style="width:8px"></div>
    <div class="small-muted" id="user-info">Protótipo • usuário: admin</div>
  </div>
</header>

<div class="main-wrap">
  <aside class="sidebar" aria-label="Navegação">
    <nav>
      <a href="#" class="active" data-section="overview">Visão Geral</a>
      <a href="#" data-section="analytics">Análises</a>
      <a href="#" data-section="ranking">Ranking & Empresas</a>
      <a href="#" data-section="evolution">Evolução Mensal</a>
      <a href="#" data-section="table">Tabela de Dados</a>
    </nav>
    <hr style="border-color: rgba(255,255,255,0.07); margin:12px 0;">
    <div class="small-muted">Dica: importe CSV com colunas nomeadas (Empresa, Valor, Objeto, Pac, Categoria, Data)</div>
  </aside>

  <main class="content">
    <!-- CONTROLS -->
    <div class="card">
      <div class="card-header">
        <div style="display:flex;gap:12px;align-items:center;">
          <div><strong>Controles</strong></div>
          <div class="small-muted">Filtros rápidos</div>
        </div>
        <div class="small-muted">Use filtros combinados — importação com mapeamento permite detectar colunas automaticamente.</div>
      </div>

      <div style="margin-top:8px;display:flex;flex-direction:column;gap:10px;">
        <div class="filters desktop-row">
          <select id="category-filter"><option value="all">Todas as categorias</option></select>
          <select id="pac-filter">
            <option value="all">Todos (PAC / Não PAC)</option>
            <option value="yes">Atendido no PAC</option>
            <option value="no">Não atendido no PAC</option>
          </select>
          <input id="value-max" type="number" placeholder="Valor máximo (R$)">
          <input id="search" type="text" placeholder="Buscar empresa ou objeto..." style="min-width:220px;">
          <button id="btn-apply" class="btn-espep">Aplicar</button>
          <button id="btn-reset" class="btn-outline-espep">Resetar</button>
          <div style="margin-left:auto;display:flex;gap:8px;">
            <input id="file-input" type="file" accept=".csv" style="display:none">
            <button id="btn-open-file" class="btn-outline-espep">Importar CSV</button>
          </div>
        </div>

        <div class="filters mobile-row">
          <select id="category-filter-mob"><option value="all">Categorias</option></select>
          <button id="btn-open-file-mob" class="btn-outline-espep">Importar</button>
          <button id="btn-apply-mob" class="btn-espep">Ok</button>
        </div>
      </div>
    </div>

    <!-- METRICS -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <div>Principais Métricas</div>
          <div class="small-muted">Resumo rápido</div>
        </div>
        <div style="margin-top:8px;" class="metrics" role="region" aria-label="Métricas">
          <div class="metric">
            <div class="label">Contratos</div>
            <div class="value" id="metric-count">0</div>
            <div class="small-muted">Total de contratos</div>
          </div>
          <div class="metric">
            <div class="label">Valor Total</div>
            <div class="value" id="metric-total">R$ 0,00</div>
            <div class="small-muted">Soma dos valores</div>
          </div>
          <div class="metric">
            <div class="label">Atendido no PAC</div>
            <div class="value" id="metric-pac">0</div>
            <div class="small-muted">Quantidade</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>Distribuição por Categoria</div>
          <div class="small-muted">Totais por categoria</div>
        </div>
        <div class="chart-box"><canvas id="chart-category"></canvas></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>PAC vs Não PAC</div>
          <div class="small-muted">Contagem</div>
        </div>
        <div class="chart-box"><canvas id="chart-pac"></canvas></div>
      </div>
    </div>

    <!-- Analytics: more charts -->
    <div id="analytics-section" class="card d-none">
      <div class="card-header">
        <div>Análises</div>
        <div class="small-muted">Gráficos complementares</div>
      </div>
      <div class="grid" style="margin-top:10px;">
        <div class="card">
          <div class="card-header">Top Empresas (Ranking Horizontal)</div>
          <div class="chart-box"><canvas id="chart-ranking"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">PAC vs Não PAC por Categoria (Empilhado)</div>
          <div class="chart-box"><canvas id="chart-pac-cat"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">Radar: Valores por Categoria</div>
          <div class="chart-box"><canvas id="chart-radar"></canvas></div>
        </div>
      </div>
    </div>

    <!-- Ranking & Companies -->
    <div id="ranking-section" class="card d-none">
      <div class="card-header"><div>Ranking de Empresas</div><div class="small-muted">Ordene e investigue</div></div>
      <div style="margin-top:6px;">
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <select id="ranking-limit"><option value="5">Top 5</option><option value="10" selected>Top 10</option><option value="20">Top 20</option></select>
          <button id="btn-update-ranking" class="btn-espep">Atualizar Ranking</button>
        </div>
        <div style="margin-top:10px;" class="chart-box"><canvas id="chart-companies"></canvas></div>
      </div>
    </div>

    <!-- Evolution monthly -->
    <div id="evolution-section" class="card d-none">
      <div class="card-header"><div>Evolução Mensal</div><div class="small-muted">Baseada na coluna Data (formato: YYYY-MM-DD ou DD/MM/YYYY)</div></div>
      <div style="margin-top:10px;" class="chart-box"><canvas id="chart-evolution"></canvas></div>
      <div class="small-muted" id="evolution-note" style="margin-top:6px; display:block;">Observação: para exibir evolução mensal, importe CSV com coluna Data (nome 'data', 'Data' ou 'date').</div>
    </div>

    <!-- Table -->
    <div id="table-section" class="card d-none">
      <div class="card-header">
        <div>Tabela de Dados</div>
        <div class="small-muted">Pesquise, filtre e exporte</div>
      </div>
      <div style="margin-top:8px;">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <input id="table-search" type="text" placeholder="Pesquisar..." style="padding:8px; border-radius:8px; flex:1;">
          <!-- Export Excel placed above the table, as requested -->
          <button id="btn-export-excel" class="btn-espep">Exportar Excel (.xlsx)</button>
          <button id="btn-export-table" class="btn-outline-espep">Exportar CSV</button>
        </div>

        <div class="table-wrap">
          <table aria-label="Tabela de compras">
            <thead>
              <tr><th>Empresa</th><th>Valor (R$)</th><th>Objeto</th><th>PAC</th><th>Categoria</th><th>Data</th></tr>
            </thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
          <div class="small-muted" id="table-info">Mostrando 0 linhas</div>
          <div>
            <button id="prev-page" class="btn-outline-espep">Anterior</button>
            <span id="page-indicator" class="small-muted">1</span>
            <button id="next-page" class="btn-outline-espep">Próxima</button>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Modal: Mapear colunas após importar -->
<div class="modal fade" id="mappingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Mapear colunas do CSV</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p class="small-muted">Selecione qual coluna corresponde a cada campo do dashboard. Campo <strong>Data</strong> é opcional.</p>
        <div class="mapping-grid">
          <div class="mapping-row"><label style="width:120px">Empresa</label><select id="map-empresa"></select></div>
          <div class="mapping-row"><label style="width:120px">Valor</label><select id="map-valor"></select></div>
          <div class="mapping-row"><label style="width:120px">Objeto</label><select id="map-objeto"></select></div>
          <div class="mapping-row"><label style="width:120px">PAC</label><select id="map-pac"></select></div>
          <div class="mapping-row"><label style="width:120px">Categoria</label><select id="map-categoria"></select></div>
          <div class="mapping-row"><label style="width:120px">Data (opcional)</label><select id="map-data"></select></div>
        </div>
        <div class="mt-3">
          <div class="small-muted">Preview (primeiras 5 linhas):</div>
          <pre id="csv-preview" style="max-height:160px; overflow:auto; background:#f8fafc; padding:8px; border-radius:6px;"></pre>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-cancel-map" class="btn-outline-espep" data-bs-dismiss="modal">Cancelar</button>
        <button id="btn-confirm-map" class="btn-espep">Confirmar e Carregar</button>
      </div>
    </div>
  </div>
</div>

<input id="hidden-file" type="file" accept=".csv" style="display:none">

<script>
/* ========= Dashboard final (single file) ========= */
/* Includes XLSX export via SheetJS (already loaded via CDN) */

/* ---------- Sample data (initial) ---------- */
const sampleData = [
  {empresa: "A.G. COMÉRCIO DE ALIMENTO", valor: 31613.11, objeto: "AQUISIÇÃO DE GÊNEROS ALIMENTICÍOS", pac: "33903007 GENEROS DE ALIMENTACAO", categoria: "Gêneros de Alimentação", data: "2024-01-15"},
  {empresa: "ADM COMERCIO E SERVIÇOS", valor: 21717.67, objeto: "INSTALAÇÃO ...", pac: "NÃO CONSTA NO PAC 2024", categoria: "Serviços", data: "2024-02-07"},
  {empresa: "PLENITUDE SEGURANÇA", valor: 311423.80, objeto: "SEGURANÇA PRIVADA", pac: "33903999 - OUTROS SERVICOS", categoria: "Segurança", data: "2024-03-21"},
  {empresa: "COMERCIAL V. DE MAT. SILVA", valor: 52800.00, objeto: "CARTEIRAS ESCOLARES", pac: "44905242 - MOBILIARIO", categoria: "Mobiliário", data: "2024-04-10"},
  {empresa: "PADARIA PONTES LTDA", valor: 42603.60, objeto: "REFEIÇÕES PARA A ESPEP", pac: "NÃO CONSTA NO PAC 2024", categoria: "Alimentação", data: "2024-05-05"}
];

/* ---------- State ---------- */
let loadedBase = [...sampleData];
let filtered = [...loadedBase];
let currentPage = 1;
const pageSize = 12;

let chCategory, chPac, chRanking, chPacCat, chRadar, chCompanies, chEvolution;
let lastParsedRows = null;

/* ---------- Utilities ---------- */
function fmtBRL(v){ return 'R$ ' + Number(v || 0).toLocaleString('pt-BR', {minimumFractionDigits:2}); }
function isPac(val){ if(!val) return false; const s = String(val).toUpperCase(); return !(s.includes('NÃO') || s.includes('NAO') || s.includes('N/A') || s.includes('NÃOP') || s.includes('NÃ O')); }
function normalizeHeader(h){ return String(h||'').trim().toLowerCase(); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function parseDateFlexible(s){
  if(!s) return null;
  s = String(s).trim();
  let d = new Date(s);
  if(!isNaN(d)) return d;
  const m = s.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})/);
  if(m) return new Date(`${m[3]}-${m[2]}-${m[1]}T00:00:00`);
  const m2 = s.match(/(\d{4})(\d{2})(\d{2})/);
  if(m2) return new Date(`${m2[1]}-${m2[2]}-${m2[3]}T00:00:00`);
  return null;
}

/* CSV parser (handles quoted fields) */
function parseCSV(text){
  const rows = [];
  let cur = '', row = [], inQuotes = false;
  for (let i=0;i<text.length;i++){
    const ch = text[i], nxt = text[i+1];
    if(ch === '"'){
      if(inQuotes && nxt === '"'){ cur += '"'; i++; } else { inQuotes = !inQuotes; }
    } else if(ch === ',' && !inQuotes){
      row.push(cur); cur=''; 
    } else if((ch === '\n' || ch === '\r') && !inQuotes){
      if(ch === '\r' && nxt === '\n'){ i++; }
      row.push(cur); rows.push(row); row=[]; cur='';
    } else { cur += ch; }
  }
  if(cur !== '' || row.length > 0){ row.push(cur); rows.push(row); }
  if(rows.length && rows[rows.length-1].length === 1 && rows[rows.length-1][0] === '') rows.pop();
  return rows;
}

/* Build data from mapped CSV rows */
function buildDataFromRows(rows, mapping){
  const data = [];
  for(let r=1;r<rows.length;r++){
    const row = rows[r];
    if(!row || row.join('').trim()==='') continue;
    const empresa = mapping.empresa !== null && row[mapping.empresa] !== undefined ? String(row[mapping.empresa]).trim() : '';
    if(!empresa) continue;
    let rawVal = mapping.valor !== null && row[mapping.valor] !== undefined ? String(row[mapping.valor]).trim() : '0';
    rawVal = rawVal.replace(/\./g,'').replace(',', '.').replace(/\s/g,'');
    let valor = Number(rawVal); if(isNaN(valor)) valor = 0;
    const objeto = mapping.objeto !== null && row[mapping.objeto] !== undefined ? String(row[mapping.objeto]).trim() : '';
    const pac = mapping.pac !== null && row[mapping.pac] !== undefined ? String(row[mapping.pac]).trim() : '';
    const categoria = mapping.categoria !== null && row[mapping.categoria] !== undefined ? String(row[mapping.categoria]).trim() : 'Outros';
    const dateRaw = mapping.data !== null && row[mapping.data] !== undefined ? String(row[mapping.data]).trim() : '';
    const dt = parseDateFlexible(dateRaw);
    const dateISO = dt ? dt.toISOString().slice(0,10) : '';
    data.push({ empresa, valor, objeto, pac: pac || 'NÃO CONSTA NO PAC 2024', categoria: categoria || 'Outros', data: dateISO });
  }
  return data;
}

/* ---------- UI updates ---------- */
function updateMetrics(){
  const totalVal = filtered.reduce((s,i)=>s + Number(i.valor||0), 0);
  const count = filtered.length;
  const pacCount = filtered.filter(i => isPac(i.pac)).length;
  document.getElementById('metric-count').textContent = count;
  document.getElementById('metric-total').textContent = fmtBRL(totalVal);
  document.getElementById('metric-pac').textContent = pacCount;
}

function updateCategoryFilter(){
  const sel = document.getElementById('category-filter');
  const selMob = document.getElementById('category-filter-mob');
  const cats = [...new Set(loadedBase.map(i => i.categoria || 'Outros'))].sort();
  sel.innerHTML = '<option value="all">Todas as categorias</option>';
  selMob.innerHTML = '<option value="all">Todas</option>';
  cats.forEach(c => {
    const opt = document.createElement('option'); opt.value = c; opt.textContent = c; sel.appendChild(opt);
    const opt2 = opt.cloneNode(true); selMob.appendChild(opt2);
  });
}

function populateTable(){
  const tbody = document.getElementById('table-body'); tbody.innerHTML = '';
  const start = (currentPage-1)*pageSize;
  const page = filtered.slice(start, start + pageSize);
  for(const r of page){
    const tr = document.createElement('tr'); if(isPac(r.pac)) tr.classList.add('highlight');
    tr.innerHTML = `<td>${escapeHtml(r.empresa)}</td><td>${fmtBRL(r.valor)}</td><td>${escapeHtml(r.objeto)}</td><td>${escapeHtml(r.pac)}</td><td>${escapeHtml(r.categoria)}</td><td>${r.data||''}</td>`;
    tbody.appendChild(tr);
  }
  document.getElementById('table-info').textContent = `Mostrando ${Math.min(pageSize, filtered.length - start)} de ${filtered.length} linhas`;
  document.getElementById('page-indicator').textContent = currentPage;
}

/* ---------- Charts ---------- */
function safeDestroy(c){ if(c){ try{ c.destroy(); } catch(e){} } }

function updateCharts(){
  // aggregate by category
  const catAgg = {}; for(const it of filtered){ const c = it.categoria || 'Outros'; catAgg[c] = (catAgg[c]||0) + Number(it.valor||0); }
  const catLabels = Object.keys(catAgg); const catValues = Object.values(catAgg);

  // pac counts
  const pacYes = filtered.filter(i => isPac(i.pac)).length; const pacNo = filtered.length - pacYes;

  // top companies
  const top = [...filtered].sort((a,b) => b.valor - a.valor);

  // pac by category values
  const pacByCat = {}; for(const it of filtered){ const c = it.categoria || 'Outros'; if(!pacByCat[c]) pacByCat[c] = {pac:0, nonPac:0}; if(isPac(it.pac)) pacByCat[c].pac += Number(it.valor||0); else pacByCat[c].nonPac += Number(it.valor||0); }
  const pacCatLabels = Object.keys(pacByCat); const pacCatPac = pacCatLabels.map(l => pacByCat[l].pac); const pacCatNon = pacCatLabels.map(l => pacByCat[l].nonPac);

  // radar
  const radarLabels = catLabels; const radarValues = catValues;

  // evolution monthly grouping (YYYY-MM)
  const hasDate = filtered.some(i => i.data);
  const evoLabels = [], evoValues = [];
  if(hasDate){
    const monthly = {};
    for(const it of filtered){ if(!it.data) continue; const mm = it.data.slice(0,7); monthly[mm] = (monthly[mm]||0) + Number(it.valor||0); }
    const months = Object.keys(monthly).sort();
    for(const m of months){ evoLabels.push(m); evoValues.push(monthly[m]); }
  }

  // destroy
  safeDestroy(chCategory); safeDestroy(chPac); safeDestroy(chRanking); safeDestroy(chPacCat); safeDestroy(chRadar); safeDestroy(chCompanies); safeDestroy(chEvolution);

  // category bar
  const ctxCat = document.getElementById('chart-category').getContext('2d');
  chCategory = new Chart(ctxCat, { type: 'bar', data:{ labels: catLabels, datasets:[{ label:'Valor (R$)', data: catValues, backgroundColor: generatePalette(catLabels.length) }]}, options:{ responsive:true, plugins:{ tooltip:{ callbacks:{ label: ctx => fmtBRL(ctx.raw) } } }, scales:{ y:{ beginAtZero:true } } } });

  // pac doughnut
  const ctxPac = document.getElementById('chart-pac').getContext('2d');
  chPac = new Chart(ctxPac, { type:'doughnut', data:{ labels:['Atendido no PAC','Não Atendido'], datasets:[{ data:[pacYes,pacNo], backgroundColor:['#2ecc71','#e74c3c'] }]}, options:{ responsive:true } });

  // ranking horizontal (top N)
  const limit = Number(document.getElementById('ranking-limit').value || 10);
  const topLimited = top.slice(0, limit);
  const ctxRank = document.getElementById('chart-ranking').getContext('2d');
  chRanking = new Chart(ctxRank, { type:'bar', data:{ labels: topLimited.map(i=>i.empresa), datasets:[{ label:'Valor (R$)', data: topLimited.map(i=>i.valor), backgroundColor: generatePalette(topLimited.length) }]}, options:{ indexAxis:'y', responsive:true, scales:{ x:{ beginAtZero:true } } } });

  // pac by cat stacked
  const ctxPacCat = document.getElementById('chart-pac-cat').getContext('2d');
  chPacCat = new Chart(ctxPacCat, { type:'bar', data:{ labels: pacCatLabels, datasets:[ { label:'Atendido', data: pacCatPac, backgroundColor:'#2ecc71' }, { label:'Não Atendido', data: pacCatNon, backgroundColor:'#e74c3c' } ] }, options:{ responsive:true, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } } });

  // radar
  const ctxRadar = document.getElementById('chart-radar').getContext('2d');
  chRadar = new Chart(ctxRadar, { type:'radar', data:{ labels: radarLabels, datasets:[{ label:'Valor (R$)', data: radarValues, backgroundColor:'rgba(52,144,221,0.18)', borderColor:'#3490dc' }] }, options:{ responsive:true } });

  // companies chart (top)
  const ctxCompanies = document.getElementById('chart-companies').getContext('2d');
  chCompanies = new Chart(ctxCompanies, { type:'bar', data:{ labels: topLimited.map(i=>i.empresa), datasets:[{ label:'Valor (R$)', data: topLimited.map(i=>i.valor), backgroundColor: generatePalette(topLimited.length) }]}, options:{ responsive:true, scales:{ y:{ beginAtZero:true } } } });

  // evolution
  const ctxEvo = document.getElementById('chart-evolution').getContext('2d');
  if(hasDate && evoLabels.length){
    chEvolution = new Chart(ctxEvo, { type:'line', data:{ labels: evoLabels, datasets:[{ label:'Valor Mensal (R$)', data: evoValues, fill:true, backgroundColor:'rgba(52,144,221,0.15)', borderColor:'#00509e', tension:0.2 }]}, options:{ responsive:true, plugins:{ tooltip:{ callbacks:{ label: ctx => fmtBRL(ctx.raw) } } }, scales:{ y:{ beginAtZero:true } } } });
    document.getElementById('evolution-note').style.display = 'none';
  } else {
    ctxEvo.clearRect(0,0,ctxEvo.canvas.width, ctxEvo.canvas.height);
    document.getElementById('evolution-note').style.display = 'block';
  }
}

/* palette */
function generatePalette(n){
  const base = ['#003366','#00509e','#3498db','#2ecc71','#f39c12','#9b59b6','#e74c3c','#16a085','#8e44ad','#f1c40f'];
  const out = [];
  for(let i=0;i<n;i++) out.push(base[i % base.length]);
  return out;
}

/* ---------- Filters & interactions ---------- */
function applyFilters(){
  const cat = (document.getElementById('category-filter').value || document.getElementById('category-filter-mob').value || 'all');
  const pac = document.getElementById('pac-filter').value;
  const maxVal = Number(document.getElementById('value-max').value || Infinity);
  const q = (document.getElementById('search').value || document.getElementById('table-search')?.value || '').trim().toLowerCase();

  filtered = loadedBase.filter(it => {
    if(cat !== 'all' && (it.categoria || '') !== cat) return false;
    if(pac === 'yes' && !isPac(it.pac)) return false;
    if(pac === 'no' && isPac(it.pac)) return false;
    if(Number(it.valor || 0) > maxVal) return false;
    if(q){
      const hay = (it.empresa + ' ' + it.objeto + ' ' + (it.categoria||'')).toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  currentPage = 1;
  updateMetrics();
  updateCharts();
  populateTable();
}

/* ---------- CSV import and mapping modal ---------- */
function openFileDialog(){ document.getElementById('hidden-file').click(); }

document.getElementById('hidden-file').addEventListener('change', function(e){
  const f = e.target.files[0]; e.target.value='';
  if(!f) return;
  if(!f.name.toLowerCase().endsWith('.csv')) return alert('Apenas arquivos .csv são aceitos.');
  const reader = new FileReader();
  reader.onload = function(ev){
    try{
      const rows = parseCSV(String(ev.target.result));
      if(!rows || rows.length < 2) return alert('CSV inválido ou sem dados.');
      lastParsedRows = rows;
      openMappingModal(rows[0], rows.slice(1,6)); // pass header and preview
    } catch(err){ console.error(err); alert('Erro ao ler CSV: ' + err.message); }
  };
  reader.readAsText(f, 'UTF-8');
});

function openMappingModal(headerRow, previewRows){
  const fields = ['(ignorar)'].concat(headerRow.map(h => h || '(vazio)'));
  ['map-empresa','map-valor','map-objeto','map-pac','map-categoria','map-data'].forEach(id => {
    const sel = document.getElementById(id); sel.innerHTML = '';
    fields.forEach((f, idx) => {
      const o = document.createElement('option'); o.value = idx-1; o.textContent = f; sel.appendChild(o);
    });
  });

  headerRow.forEach((h, idx) => {
    const norm = normalizeHeader(h);
    if(norm.includes('empresa') || norm.includes('fornecedor') || norm.includes('nome')) document.getElementById('map-empresa').value = idx;
    if(norm.includes('valor') || norm.includes('vlor') || norm.includes('total')) document.getElementById('map-valor').value = idx;
    if(norm.includes('objeto') || norm.includes('descr')) document.getElementById('map-objeto').value = idx;
    if(norm.includes('pac')) document.getElementById('map-pac').value = idx;
    if(norm.includes('categoria') || norm.includes('cat')) document.getElementById('map-categoria').value = idx;
    if(norm.includes('data') || norm.includes('date') || norm.includes('mes')) document.getElementById('map-data').value = idx;
  });

  // preview
  const preview = previewRows || [];
  document.getElementById('csv-preview').textContent = preview.map(r => r.join(' | ')).join('\n') || '(sem pré-visualização)';

  new bootstrap.Modal(document.getElementById('mappingModal')).show();
}

document.getElementById('btn-confirm-map').addEventListener('click', function(){
  const getSel = id => Number(document.getElementById(id).value);
  const mapping = { empresa: getSel('map-empresa'), valor: getSel('map-valor'), objeto: getSel('map-objeto'), pac: getSel('map-pac'), categoria: getSel('map-categoria'), data: getSel('map-data') };
  Object.keys(mapping).forEach(k => { if(mapping[k] < 0) mapping[k] = null; });
  const data = buildDataFromRows(lastParsedRows, mapping);
  if(!data || data.length === 0) { alert('Nenhum registro válido encontrado após o mapeamento.'); return; }
  loadedBase = data; filtered = [...loadedBase];
  updateCategoryFilter(); applyFilters();
  bootstrap.Modal.getInstance(document.getElementById('mappingModal')).hide();
  alert('CSV importado com sucesso: ' + data.length + ' linhas.');
});

/* ---------- Export to XLSX (SheetJS) ---------- */
function exportToXLSX(){
  if(!filtered || filtered.length === 0) return alert('Sem dados para exportar.');
  // build sheet data (array of arrays)
  const header = ['Empresa','Valor','Objeto','PAC','Categoria','Data'];
  const aoa = [header];
  for(const r of filtered){
    aoa.push([ r.empresa, Number(r.valor || 0), r.objeto, r.pac, r.categoria, r.data || '' ]);
  }
  // create workbook & worksheet
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Compras');
  // style: set column widths (basic)
  ws['!cols'] = [{wpx:240},{wpx:120},{wpx:320},{wpx:160},{wpx:160},{wpx:100}];
  // write file
  XLSX.writeFile(wb, 'compras_espep.xlsx');
}

/* ---------- CSV export (aux) ---------- */
function exportCSV(){
  if(!filtered || filtered.length === 0) return alert('Sem dados para exportar.');
  const headers = ['Empresa','Valor','Objeto','Pac','Categoria','Data'];
  const lines = [headers.join(',')];
  for(const r of filtered){
    const row = [
      `"${String(r.empresa||'').replace(/"/g,'""')}"`,
      Number(r.valor||0),
      `"${String(r.objeto||'').replace(/"/g,'""')}"`,
      `"${String(r.pac||'').replace(/"/g,'""')}"`,
      `"${String(r.categoria||'').replace(/"/g,'""')}"`,
      `"${String(r.data||'').replace(/"/g,'""')}"`
    ];
    lines.push(row.join(','));
  }
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'compras_espep_export.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ---------- Wiring UI ---------- */
function init(){
  loadedBase = [...sampleData]; filtered = [...loadedBase];
  updateCategoryFilter(); updateCharts(); updateMetrics(); populateTable();

  // buttons & events
  document.getElementById('btn-open-file').addEventListener('click', openFileDialog);
  document.getElementById('btn-open-file-mob').addEventListener('click', openFileDialog);
  document.getElementById('btn-import-top').addEventListener('click', openFileDialog);
  document.getElementById('btn-export-top').addEventListener('click', exportToXLSX);
  document.getElementById('btn-export-excel').addEventListener('click', exportToXLSX);
  document.getElementById('btn-export-table').addEventListener('click', exportCSV);

  document.getElementById('hidden-file').addEventListener('change', function(e){ const ev = new Event('change'); document.getElementById('hidden-file').dispatchEvent(ev); });
  // the hidden-file change is handled above; wire file input to same input
  document.getElementById('file-input').addEventListener('change', function(e){
    document.getElementById('hidden-file').files = e.target.files;
    document.getElementById('hidden-file').dispatchEvent(new Event('change'));
    e.target.value = '';
  });

  document.getElementById('btn-apply').addEventListener('click', applyFilters);
  document.getElementById('btn-apply-mob').addEventListener('click', applyFilters);
  document.getElementById('btn-reset').addEventListener('click', () => { document.getElementById('category-filter').value='all'; document.getElementById('pac-filter').value='all'; document.getElementById('value-max').value=''; document.getElementById('search').value=''; applyFilters(); });

  document.getElementById('search').addEventListener('input', applyFilters);
  document.getElementById('table-search').addEventListener('input', function(){ document.getElementById('search').value = this.value; applyFilters(); });

  document.getElementById('prev-page').addEventListener('click', () => { if(currentPage>1){ currentPage--; populateTable(); }});
  document.getElementById('next-page').addEventListener('click', () => { if(currentPage * pageSize < filtered.length){ currentPage++; populateTable(); }});

  document.getElementById('btn-update-ranking').addEventListener('click', updateCharts);

  // wire hidden-file to parseCSV flow (already configured above)
  document.getElementById('hidden-file').addEventListener('change', function(e){
    const f = e.target.files[0]; e.target.value='';
    if(!f) return;
    if(!f.name.toLowerCase().endsWith('.csv')) return alert('Apenas arquivos .csv são aceitos.');
    const reader = new FileReader();
    reader.onload = function(ev){
      try{
        const rows = parseCSV(String(ev.target.result));
        if(!rows || rows.length < 2) return alert('CSV inválido ou sem dados.');
        lastParsedRows = rows;
        openMappingModal(rows[0], rows.slice(1,6));
      } catch(err){ console.error(err); alert('Erro ao ler CSV: ' + err.message); }
    };
    reader.readAsText(f, 'UTF-8');
  });

  // sidebar navigation
  document.querySelectorAll('aside nav a').forEach(a => {
    a.addEventListener('click', function(ev){
      ev.preventDefault();
      document.querySelectorAll('aside nav a').forEach(x => x.classList.remove('active'));
      this.classList.add('active');
      const sec = this.getAttribute('data-section');
      document.getElementById('analytics-section').classList.add('d-none');
      document.getElementById('ranking-section').classList.add('d-none');
      document.getElementById('evolution-section').classList.add('d-none');
      document.getElementById('table-section').classList.add('d-none');
      if(sec === 'analytics') document.getElementById('analytics-section').classList.remove('d-none');
      if(sec === 'ranking') document.getElementById('ranking-section').classList.remove('d-none');
      if(sec === 'evolution') document.getElementById('evolution-section').classList.remove('d-none');
      if(sec === 'table') document.getElementById('table-section').classList.remove('d-none');
      populateTable();
    });
  });

  // Drag & drop CSV (optional)
  document.body.addEventListener('dragover', e => e.preventDefault());
  document.body.addEventListener('drop', e => {
    e.preventDefault();
    const f = e.dataTransfer.files[0];
    if(f && f.name && f.name.toLowerCase().endsWith('.csv')){
      const reader = new FileReader();
      reader.onload = ev => { const rows = parseCSV(String(ev.target.result)); lastParsedRows = rows; openMappingModal(rows[0], rows.slice(1,6)); };
      reader.readAsText(f, 'UTF-8');
    }
  });
}

/* ---------- Initialize ---------- */
init();
</script>

</body>
</html>
